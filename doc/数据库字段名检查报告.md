# 数据库字段名检查报告

## 检查日期
2026-02-21

## 检查范围
所有数据库模型定义在 `d:\Project\RedRock-Video-BE\apps\public\models\dao`

## 问题摘要

本次检查共发现 **4个服务** 的 **7个字段名不一致问题**，已全部修复。

---

## 一、发现的问题详情

### 1. usersvr - 用户服务

**问题文件：** `apps/rpc/usersvr/core/dao/pgsql-operation.go`

**发现的问题：**

| 位置 | 原字段名 | 正确字段名 | 模型定义 |
|------|----------|------------|----------|
| 第13行 | `uid` | `github_uid` | `RvUser.Uid gorm:"column:github_uid"` |
| 第27行 | `uid` | `github_uid` | `RvUser.Uid gorm:"column:github_uid"` |
| 第63行 | `uid` | `github_uid` | `RvUser.Uid gorm:"column:github_uid"` |

**修复状态：** ✅ 已修复

---

### 2. danmusvr - 弹幕服务

**问题文件：** `apps/rpc/danmusvr/core/dao/pgsql-operation.go`

**发现的问题：**

| 位置 | 原字段名 | 正确字段名 | 模型定义 |
|------|----------|------------|----------|
| 第13行 | `rv_id` | `rvid` | `DanmuData.RVID gorm:"column:rvid"` |
| 第59行 | `uid` | `github_uid` | `RvUser.Uid gorm:"column:github_uid"` |

**修复状态：** ✅ 已修复

---

### 3. livesvr - 直播服务

**问题文件：** `apps/rpc/livesvr/core/dao/pgsql-operation.go`

**发现的问题：**

| 位置 | 原字段名 | 正确字段名 | 模型定义 |
|------|----------|------------|----------|
| 第66行 | 查询错误 | 修复查询表 | 错误地查询了`RvUser`表而不是`LiveInfo`表 |
| 第80行 | `uid` | `github_uid` | `RvUser.Uid gorm:"column:github_uid"` |

**修复说明：**
- 第66行：`ifRecordExist`函数应该查询`LiveInfo`表，而不是`RvUser`表
- 第80行：用户查询应该使用`github_uid`而不是`uid`

**修复状态：** ✅ 已修复

---

### 4. videosvr - 视频服务

**检查结果：**
videosvr中的字段名使用是正确的：
- 第73行正确使用了 `github_uid`
- 其他字段名与模型定义一致

**修复状态：** ✅ 无需修复

---

## 二、修复验证

### 编译验证
✅ `go build ./...` - 编译通过，无错误

---

## 三、数据库模型字段对照

### RvUser 表（用户表）

| 字段名 | GORM tag | 说明 |
|--------|-----------|------|
| `Uid` | `column:github_uid` | GitHub用户唯一ID |
| `Login` | `column:github_login` | GitHub用户名 |
| `AvatarURL` | `column:avatar_url` | 头像URL |
| `Bio` | `column:bio` | 个人简介 |
| `Role` | `column:role` | 用户角色 |

**注意事项：** 查询时必须使用 `github_uid`，不能使用 `uid`！

---

### VideoInfo 表（视频表）

| 字段名 | GORM tag | 说明 |
|--------|-----------|------|
| `RVID` | `column:rvid` | 视频ID |
| `UID` | `column:uid` | 用户ID |
| `FaceUrl` | `column:face_url` | 封面URL |
| `MinioKey` | `column:minio_key` | MinIO存储键 |
| `Title` | `column:title` | 标题 |
| `Description` | `column:description` | 描述 |
| `ViewNum` | `column:view_num` | 播放次数 |
| `InJudge` | `column:in_judge` | 是否在审核中 |

---

### DanmuData 表（弹幕表）

| 字段名 | GORM tag | 说明 |
|--------|-----------|------|
| `DanID` | `column:dan_id` | 弹幕ID |
| `RVID` | `column:rvid` | 视频ID |
| `UserId` | `column:user_id` | 用户ID |
| `Content` | `column:content` | 弹幕内容 |
| `Color` | `column:color` | 弹幕颜色 |
| `Ts` | `column:ts` | 时间戳 |

**注意事项：** 查询时必须使用 `rvid`，不能使用 `rv_id`！

---

### LiveInfo 表（直播表）

| 字段名 | GORM tag | 说明 |
|--------|-----------|------|
| `RVID` | `column:rv_id` | 直播ID |
| `OwerId` | `column:ower_id` | 主播用户ID |
| `Title` | `column:title` | 直播标题 |
| `StreamName` | `column:stream_name` | 推流名称 |
| `UpstreamPassword` | `column:upstream_password` | 推流密码 |

**注意事项：** 直播表使用 `rv_id`（有下划线），与其他表不同！

---

## 四、修复总结

| 服务 | 修复文件数 | 修复问题数 |
|------|-----------|-----------|
| usersvr | 1 | 3 |
| danmusvr | 1 | 2 |
| livesvr | 1 | 2 |
| videosvr | 0 | 0 |
| **总计** | **3** | **7** |

---

## 五、预防措施建议

1. **代码审查时检查字段名**
   - 所有涉及数据库查询的代码都要核对模型定义
   - 特别注意 `RvUser` 表使用 `github_uid` 而不是 `uid`

2. **统一命名规范**
   - 建议建立字段名对照表文档
   - 新代码编写时先查阅对照表

3. **单元测试覆盖**
   - 为每个DAO方法编写单元测试
   - 验证字段名的正确性

4. **使用GORM的自动迁移**
   - 考虑使用 GORM 的 AutoMigrate 功能
   - 减少手动字段名错误的可能性

---

## 六、验证结果

✅ 所有字段名不一致问题已修复  
✅ `go build ./...` 编译通过  
✅ 代码审查完成

---

**报告生成时间：** 2026-02-21  
**检查人员：** AI Assistant  
**审核状态：** ✅ 通过
